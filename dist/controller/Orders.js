sap.ui.define(["sap/ui/base/Object","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,a){"use strict";return e.extend("com.digiArtitus.controller.Orders",{constructor:function(e){this._oInstance=e;this._oView=e.getView();this.oViewModel=this._oView.getModel("oViewModel")},liveOrders:function(){firebase.firestore().collection("DATABASE").doc(com.digiArtitus.companyCode).collection("ORDERS").onSnapshot(function(e){var t=this.oViewModel.getData();var a=[];e.forEach(function(e){var t;if(typeof e.data().TIME_STAMP==="number"){t=new Date(e.data().TIME_STAMP)}else{t=e.data().TIME_STAMP.toDate()}a.push({DOC_REF:e.ref,USER_ID:e.data().USER_ID,USER_COMPANY_CODE:e.data().USER_COMPANY_CODE,TIME_STAMP:t,TIME_AGO:moment(t).fromNow(),MOMENT_TIME_STAMP:moment(t),ORDER_ID:e.data().ORDER_ID,ORDER_TYPE:e.data().ORDER_TYPE,ORDER_STATUS:e.data().ORDER_STATUS,TOTAL_PRICE:parseFloat(e.data().TOTAL_PRICE).toFixed(2),TOTAL_PAYABLE:parseFloat(e.data().TOTAL_PAYABLE),DELIVERY_CHARGE:e.data().DELIVERY_CHARGE,CUSTOMER:e.data().CUSTOMER,ITEMS:e.data().ITEMS})});a=_.orderBy(a,function(e){return e.MOMENT_TIME_STAMP},["desc"]);t.ORDERS=a;var r=moment().startOf("day");var o=moment().endOf("day");var s=_.filter(a,function(e){return e.MOMENT_TIME_STAMP.isBetween(r,o)});var T=_.flatMap(s,e=>_(e.ITEMS).map(e=>({NAME:e.MENU,QUANTITY:parseInt(e.QUANTITY,10)})).value());var d=_(T).groupBy("NAME").map((e,t)=>({MENU:t,COUNT:_.sumBy(e,"QUANTITY")})).value();d=_.orderBy(d,["COUNT"],["desc"]);t.MENU_COUNT=d;var i=_.sumBy(s,"TOTAL_PAYABLE");t.TODAY_TOTAL_PRICE=i;var n=[];var E=[];var O=[];var M=null;var A=null;for(var l=1;l<8;l++){M=moment().startOf("day").subtract(l,"day");A=moment().endOf("day").subtract(l,"day");n=_.filter(a,function(e){return e.MOMENT_TIME_STAMP.isBetween(M,A)});E=_.sumBy(n,"TOTAL_PAYABLE");O.push({Day:M.format("ddd"),Revenue:E})}var R=O[0].Revenue;var m=R-i;var u;if(R>0){u=m/R*100}else{u=m/100;u=Math.abs(u)}t.PERCENTAGE_DIFFERENCE=u;if(!this.LOAD_CHART_ONLY_ONCE){this.LOAD_CHART_ONLY_ONCE=true;this._oInstance.chart.loadChart(O)}var f=this._oView.byId("orders-id"),S=f.getBinding("items"),D=moment().startOf("day"),I=moment().endOf("day"),c=[];t.bOrdersToday=true;t.bOrdersAll=false;c.push(new sap.ui.model.Filter("TIME_STAMP","BT",D,I));S.filter(c);this.oViewModel.refresh()}.bind(this))},toggleOrders:function(e){var t=this._oInstance.byId("orders-id"),a=t.getBinding("items"),r=moment().startOf("day"),o=moment().endOf("day"),s=this.oViewModel.getData(),T=[];var d=e.getSource().data("orders")==="TODAY";s.bOrdersToday=d;s.bOrdersAll=!d;if(!d){r.set({year:2019,month:"1"})}T.push(new sap.ui.model.Filter("TIME_STAMP","BT",r,o));a.filter([T]);this.oViewModel.refresh()},ordersExport:function(){var e=this.oViewModel.getData().ORDERS;var t=[];for(var r=0,o=e.length;r<o;r++){if(moment(e[r].TIME_STAMP).isSame(moment(),"day")){t.push(e[r])}}if(t.length===0){a.show("No orders present TODAY to download!")}var s=[];for(r=0,o=t.length;r<o;r++){s.push({"Order ID":t[r].ORDER_ID,Name:t[r].CUSTOMER.NAME,"Phone No.":t[r].CUSTOMER.PHONE_NO,"Total Price":t[r].TOTAL_PAYABLE.toFixed(2),Address:t[r].CUSTOMER.ADDRESS+", "+t[r].CUSTOMER.CITY+", "+t[r].CUSTOMER.STATE+", "+t[r].CUSTOMER.COUNTRY+".",Signature:""})}var T="Orders"+(new Date).getTime();var d="xls";exportFromJSON({data:s,fileName:T,exportType:d})}})});