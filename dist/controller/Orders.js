sap.ui.define(["sap/ui/base/Object","sap/m/MessageBox","sap/m/MessageToast","com/digiArtitus/model/formatter"],function(e,t,a,r){"use strict";return e.extend("com.digiArtitus.controller.Orders",{constructor:function(e){this._oInstance=e;this._oView=e.getView();this.oViewModel=this._oView.getModel("oViewModel")},liveOrders:function(){firebase.firestore().collection("DATABASE").doc(com.digiArtitus.companyCode).collection("ORDERS").onSnapshot(function(e){var t=this.oViewModel.getData();var a=[];e.forEach(function(e){var t;if(typeof e.data().TIME_STAMP==="number"){t=new Date(e.data().TIME_STAMP)}else{t=e.data().TIME_STAMP.toDate()}a.push({DOC_REF:e.ref,USER_ID:e.data().USER_ID,USER_COMPANY_CODE:e.data().USER_COMPANY_CODE,TIME_STAMP:t,TIME_AGO:moment(t).fromNow(),MOMENT_TIME_STAMP:moment(t),ORDER_ID:e.data().ORDER_ID,ORDER_TYPE:e.data().ORDER_TYPE,ORDER_STATUS:e.data().ORDER_STATUS,TOTAL_PRICE:parseFloat(e.data().TOTAL_PRICE).toFixed(2),TOTAL_PAYABLE:parseFloat(e.data().TOTAL_PAYABLE),DELIVERY_CHARGE:e.data().DELIVERY_CHARGE,CUSTOMER:e.data().CUSTOMER,ITEMS:e.data().ITEMS})});a=_.orderBy(a,function(e){return e.MOMENT_TIME_STAMP},["desc"]);t.ORDERS=a;var o=moment().startOf("day");var i=moment().endOf("day");var s=_.filter(a,function(e){return e.MOMENT_TIME_STAMP.isBetween(o,i)});var n=_.flatMap(s,e=>_(e.ITEMS).map(e=>({NAME:e.MENU,QUANTITY:parseInt(e.QUANTITY,10)})).value());var d=_(n).groupBy("NAME").map((e,t)=>({MENU:t,COUNT:_.sumBy(e,"QUANTITY")})).value();d=_.orderBy(d,["COUNT"],["desc"]);t.MENU_COUNT=d;var T=_.sumBy(s,"TOTAL_PAYABLE");t.TODAY_TOTAL_PRICE=T;var u=[];var E=[];var l=[];var O=null;var m=null;for(var S=1;S<8;S++){O=moment().startOf("day").subtract(S,"day");m=moment().endOf("day").subtract(S,"day");u=_.filter(a,function(e){return e.MOMENT_TIME_STAMP.isBetween(O,m)});E=_.sumBy(u,"TOTAL_PAYABLE");l.push({Day:O.format("ddd"),Revenue:E})}var A=l[0].Revenue;var c=A-T;var R;if(A>0){R=c/A*100}else{R=c/100;R=Math.abs(R)}t.PERCENTAGE_DIFFERENCE=R;if(!this.LOAD_CHART_ONLY_ONCE){this.LOAD_CHART_ONLY_ONCE=true}var D=this._oView.byId("orders-id"),I=D.getBinding("items"),M=moment().startOf("day"),p=moment().endOf("day"),g=[];t.bOrdersToday=true;t.bOrdersAll=false;g.push(new sap.ui.model.Filter("TIME_STAMP","BT",M,p));I.filter(g);var C=moment();var f=parseFloat(t.TODAY_TOTAL_PRICE)===0;var h=0;var y=[];d=_.sortBy(d,["COUNT"]).reverse();for(S=0,h=d.length;S<h;S++){y.push({Name:d[S].MENU,Description:"",Count:d[S].COUNT,State:"Warning"});if(S===4){break}}t.DASHBOARD_SALES={"sap.card":{type:"List",header:{type:"Numeric",data:{json:{kpiInfos:{kpi:{number:parseFloat(t.TODAY_TOTAL_PRICE,10).toFixed(2),unit:"K",trend:f?"Down":"Up",state:f?"Error":"Success",target:{number:250,unit:"K"},deviation:{number:25},details:"Q"+C.quarter()+", "+C.get("year")}}},path:"/kpiInfos/kpi"},title:"Top 5 products sales",subTitle:"By average today income",unitOfMeasurement:"INR",mainIndicator:{number:"{number}",unit:"{unit}",trend:"{trend}",state:"{state}"},sideIndicators:[{title:"Target",number:"{target/number}",unit:"{target/unit}"},{title:"Deviation",number:"{deviation/number}",unit:"%"}],details:"{details}"},content:{data:{json:y},item:{title:"{Name}",description:"{Description}",info:{value:"{Count} No",state:"{State}"}}}}};var N=[];s=t.ORDERS;for(S=0,h=s.length;S<h;S++){N.push({salesOrder:s[S].ORDER_ID,customerName:_(s[S].CUSTOMER.NAME).replace(/(.{15})..+/,"$1â€¦"),netAmount:com.digiArtitus.FormattedCurrency(s[S].TOTAL_PAYABLE),status:s[S].ORDER_STATUS,statusState:r.orderStatus(s[S].ORDER_STATUS)});if(S===8){break}}t.DASHBOARD_SALES_TABLE={"sap.card":{type:"Table",data:{json:N},header:{title:"Sales Orders for Surgical",subTitle:"Today",status:{text:"{headerData/statusText}"}},content:{row:{columns:[{title:"Sales Order",value:"{salesOrder}",identifier:true},{title:"Customer",value:"{customerName}"},{title:"Net Amount",value:"{netAmount}"},{title:"Status",value:"{status}",state:"{statusState}"}]}}}};this.oViewModel.refresh()}.bind(this))},toggleOrders:function(e){var t=this._oInstance.byId("orders-id"),a=t.getBinding("items"),r=moment().startOf("day"),o=moment().endOf("day"),i=this.oViewModel.getData(),s=[];var n=e.getSource().data("orders")==="TODAY";i.bOrdersToday=n;i.bOrdersAll=!n;if(!n){r.set({year:2019,month:"1"})}s.push(new sap.ui.model.Filter("TIME_STAMP","BT",r,o));a.filter([s]);this.oViewModel.refresh()},ordersExport:function(){var e=this.oViewModel.getData().ORDERS;var t=[];for(var r=0,o=e.length;r<o;r++){if(moment(e[r].TIME_STAMP).isSame(moment(),"day")){t.push(e[r])}}if(t.length===0){a.show("No orders present TODAY to download!")}var i=[];for(r=0,o=t.length;r<o;r++){i.push({"Order ID":t[r].ORDER_ID,Name:t[r].CUSTOMER.NAME,"Phone No.":t[r].CUSTOMER.PHONE_NO,"Total Price":t[r].TOTAL_PAYABLE.toFixed(2),Address:t[r].CUSTOMER.ADDRESS+", "+t[r].CUSTOMER.CITY+", "+t[r].CUSTOMER.STATE+", "+t[r].CUSTOMER.COUNTRY+".",Signature:""})}var s="Orders"+(new Date).getTime();var n="xls";exportFromJSON({data:i,fileName:s,exportType:n})},_customerInfoDialog:function(){if(!this.customerInfoDialog){var e=this._oView;this.customerInfoDialog=sap.ui.xmlfragment(e.getId(),"com.digiArtitus.fragment.orders-customer-info",this);e.addDependent(this.customerInfoDialog);jQuery.sap.syncStyleClass("sapUiSizeCompact",e,this.customerInfoDialog)}return this.customerInfoDialog},onOrderTypePress:function(e){var t=e.getSource();var a=e.getSource().getBindingContext("oViewModel").getObject();var r=[{pageId:"employeePageId",header:"Customer Info",icon:"sap-icon://customer",title:a.CUSTOMER.NAME,description:"Customer",groups:[{heading:"Contact Details",elements:[{label:"Phone",value:"+91"+a.CUSTOMER.PHONE_NO,elementType:sap.m.QuickViewGroupElementType.phone},{label:"Email",value:a.CUSTOMER.EMAIL_ID,emailSubject:"Subject",elementType:sap.m.QuickViewGroupElementType.email},{label:"Address",value:a.CUSTOMER.ADDRESS+", "+a.CUSTOMER.CITY+", "+a.CUSTOMER.STATE+", "+a.CUSTOMER.COUNTRY+".",elementType:sap.m.QuickViewGroupElementType.text}]}]}];this.oViewModel.setProperty("/ORDER_CUSTOMER_INFO",r);jQuery.sap.delayedCall(0,this,function(){this._customerInfoDialog().openBy(t)})},_orderStatusDialog:function(){if(!this.orderStatusDialog){var e=this._oView;this.orderStatusDialog=sap.ui.xmlfragment(e.getId(),"com.digiArtitus.fragment.order-status",this);e.addDependent(this.orderStatusDialog);jQuery.sap.syncStyleClass("sapUiSizeCompact",e,this.orderStatusDialog)}return this.orderStatusDialog},onOrderStatusPress:function(e){var t=e.getSource();var r=e.getSource().getBindingContext("oViewModel").getObject();this.oViewModel.setProperty("/ORDER_STATUS_EDIT",r);if(!r.MOMENT_TIME_STAMP.isSame(moment(),"day")){a.show("Order status for previous dates cannot be changed");return}if(r.ORDER_STATUS.toUpperCase()==="CANCELLED"){a.show("Order cancelled by the user, Status cannot be changed");return}jQuery.sap.delayedCall(0,this,function(){this._orderStatusDialog().openBy(t)})},onStatusChanged:function(e){com.digiArtitus.StartGlobalBusyIndicator();var t=this.oViewModel.getProperty("/ORDER_STATUS_EDIT");t.DOC_REF.update({ORDER_STATUS:e.getSource().data("key")}).then(com.digiArtitus.EndGlobalBusyIndicator()).catch(function(e){a.show("Error in posting data");com.digiArtitus.EndGlobalBusyIndicator()})},onCloseDisplayItems:function(){this.orderItemsDisplayDialog.close()},onOrderItemsPress:function(e){var t=e.getSource().getBindingContext("oViewModel").getObject();this.oViewModel.setProperty("/DISPLAY_ORDERS",t.ITEMS);if(!this.orderItemsDisplayDialog){var a=this._oView;this.orderItemsDisplayDialog=sap.ui.xmlfragment(a.getId(),"com.digiArtitus.fragment.orders-display-items",this);a.addDependent(this.orderItemsDisplayDialog);jQuery.sap.syncStyleClass("sapUiSizeCompact",a,this.orderItemsDisplayDialog)}this.orderItemsDisplayDialog.open()},onOrderReceiptPress:function(e){var t=this._oView.getModel("i18n").getResourceBundle(),a=t.getText("RECEIPT_URL"),r=e.getSource().getBindingContext("oViewModel").getObject(),o=[],i="",s="",n={USER_PATH:com.digiArtitus.userId,GST_NO:r.GST_NO,ORDER_ID:r.ORDER_ID,COMPANY_CODE:r.USER_COMPANY_CODE,ORDER_TYPE:r.ORDER_TYPE,ORDER_DATE:moment(r.TIME_STAMP).format("Do MMM YYYY"),CUSTOMER:r.CUSTOMER,DELIVERY_CHARGE:r.DELIVERY_CHARGE,TOTAL_PRICE:r.TOTAL_PRICE,GRAND_TOTAL:parseFloat(r.TOTAL_PAYABLE).toFixed(2)};o.push({ITEM_NAME:"Item",ITEM_DESCRIPTION:"Description",SALE_PRICE:"Unit Cost",QUANTITY:"Quantity",TOTAL_PRICE:"Line Total"});for(var d=0,T=r.ITEMS.length;d<T;d++){o.push({ITEM_NAME:r.ITEMS[d].NAME,ITEM_DESCRIPTION:r.ITEMS[d].DESCRIPTION,SALE_PRICE:r.ITEMS[d].SALE_PRICE,QUANTITY:r.ITEMS[d].QUANTITY,TOTAL_PRICE:r.ITEMS[d].TOTAL_PRICE})}n.ITEMS=o;i=encodeURIComponent(JSON.stringify(n));s=a+i;sap.m.URLHelper.redirect(s,true)}})});