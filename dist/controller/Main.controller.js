sap.ui.define(["sap/ui/core/mvc/Controller","com/digiArtitus/controller/User","com/digiArtitus/controller/Banner","com/digiArtitus/controller/Chart","com/digiArtitus/controller/Database","com/digiArtitus/controller/Orders","sap/ui/model/json/JSONModel","com/digiArtitus/model/formatter","sap/ui/model/Filter","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,i,n,s,o,a,r,l,d,u){"use strict";return e.extend("com.digiArtitus.controller.Main",{formatter:r,model:new a,onInit:function(){this.getView().addStyleClass(this.getOwnerComponent().getContentDensityClass());this.user=new t(this);this.banner=new i(this);this.chart=new n(this);this.database=new s(this);this.orders=new o(this);this.user.checkForLogin().then(function(){this.user.loadUserData().then(function(){this.banner.liveBannerCollectionUpdates();this.banner.liveBannerItemsUpdates();this.database.liveDatabaseCollectionUpdates();this.database.liveDatabaseMenuUpdates();this.database.liveDatabaseItemUpdates();this.orders.liveOrders()}.bind(this))}.bind(this))},onToogleNavButtonPress:function(){var e=function(e){var t=this.byId("sideNavigationToggleButton");if(e){t.setTooltip("Expand")}else{t.setTooltip("Collapse")}}.bind(this);var t=this.getView().getId();var i=sap.ui.getCore().byId(t+"--toolPage");var n=i.getSideExpanded();e(n);i.setSideExpanded(!i.getSideExpanded())},onSideNavItemSelect:function(e){if(e.getParameter("item").getProperty("text")==="Logout"){this._logout()}if(e.getParameter("item").getProperty("text")==="Billing"){this._billingPageDefaults()}if(e.getParameter("item").getProperty("text")==="Settings"){this._settingsPageDefaults()}var t=e.getParameter("item");var i=this.getView().getId();sap.ui.getCore().byId(i+"--pageContainer").to(i+"--"+t.getKey())},onListUpdateFinished:function(e){var t=e.getParameter("total"),i=e.getSource();if(t===0){var n=this.getView().getModel("oViewModel"),s=n.getData();if(i.getId().search("banner-item-list-id")!==-1){s.BANNER_ITEM_PREVIEW=""}n.refresh();return}var o=i.getItems();i.setSelectedItem(o[0],true);i.fireItemPress({listItem:o[0],srcControl:i})},onBannerCollectionListPress:function(e){var t=e.getParameter("listItem").getBindingContext("oViewModel").getObject();this._listItemFilter("banner-item-list-id","BANNER_COLLECTION",t.NAME)},onBannerItemListPress:function(e){var t=this.getView().getModel("oViewModel"),i=t.getData(),n=e.getParameter("listItem"),s="";if(n){s=n.getBindingContext("oViewModel").getObject().IMAGE_URL}i.BANNER_ITEM_PREVIEW=s;t.refresh()},_listItemFilter:function(e,t,i){var n=this.getView().byId(e),s=n.getBinding("items"),o;o=new l("BANNER_COLLECTION","EQ",i);s.filter([o])},_validateInput:function(e){var t=e.getBinding("value"),i="None",n=false;try{t.getType().validateValue(e.getValue())}catch(t){i="Error";n=true;e.focus()}e.setValueState(i);return n},onBannerCollectionDialogAddPress:function(){this.banner._bannerCollectionDialog().open()},onBannerCollectionListEditPress:function(e){this.banner.bannerCollectionEdit(e)},onBannerCollectionListDeletePress:function(e){this._deleteEntry(e,false)},onBannerItemAddPress:function(){this.banner._bannerItemDialog().open()},onBannerItemListDeletePress:function(e){this._deleteEntry(e,true)},onBannerItemListEditPress:function(e){this.banner.bannerItemEdit(e)},onCollectionDialogAddPress:function(){this.database._collectionDialog().open()},onCollectionListPress:function(e){this.database.onCollectionListPress(e)},onCollectionListEditPress:function(e){this.database.onCollectionListEditPress(e)},onCollectionListDeletePress:function(e){this._deleteEntry(e,false)},onMenuListPress:function(e){this.database.onMenuListPress(e)},onMenuListEditPress:function(e){this.database.onMenuListEditPress(e)},onMenuDialogAddPress:function(){this.database._menuDialog().open()},onMenuListDeletePress:function(e){this._deleteEntry(e,true)},onItemDialogAddPress:function(){this.database._itemDialog().open()},onItemListPress:function(e){this.database.onItemListPress(e)},onItemListDeletePress:function(e){this._deleteEntry(e,true)},onItemListEditPress:function(e){this.database.onItemListEditPress(e)},onOrdersToggleBtn:function(e){this.orders.toggleOrders(e)},onDataExport:function(e){this.orders.ordersExport()},_deleteEntry:function(e,t){var i=e.getSource();var n=i.getBindingContext("oViewModel").getObject();var s=function(){var e=$.Deferred();var t=!!this.getView().$().closest(".sapUiSizeCompact").length;d.warning("Confirm to delete",{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],styleClass:t?"sapUiSizeCompact":"",onClose:function(t){if(t==="OK"){e.resolve("create")}}});return e.promise()}.bind(this);$.when(s()).done(function(e){com.digiArtitus.StartGlobalBusyIndicator();var i=function(){n.DOC_REF.delete().then(function(){com.digiArtitus.EndGlobalBusyIndicator()}).catch(function(e){u.show("Error in posting data");com.digiArtitus.EndGlobalBusyIndicator()})};if(t){var s=firebase.storage().ref();var o=s.child(n.IMAGE_REF_PATH);o.delete().then(i).catch(function(e){com.digiArtitus.EndGlobalBusyIndicator()})}else{i()}})},_fileUploaderUnLoad:function(e,t,i,n,s){var o=this.getView().byId(e),a=this.getView().getModel("oViewModel"),r=a.getData();o.setValue("");r[t]=null;r[i]=false;r[n]="";r[s]=false;a.refresh()},_fileUploaderLoad:function(e,t,i,n,s,o){var a=this.getView().byId(e),r=this.getView().getModel("oViewModel"),l=r.getData();if(!a.getValue()){u.show("Choose a file first");return}var d=jQuery.sap.domById(a.getId()+"-fu").files[0];var c=function(e,t){if(e===0){return"0 Bytes"}var i=1024,n=t||2,s=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],o=Math.floor(Math.log(e)/Math.log(i));return parseFloat((e/Math.pow(i,o)).toFixed(n))+" "+s[o]};var g=l.MAX_FILE_ATTACHMENT_SIZE;if(d.size>g){u.show("File size "+c(d.size)+" exceeding "+c(g));com.digiArtitus.EndGlobalBusyIndicator();return}var f;if(d){l[t]=d;f=new FileReader;f.onload=function(){if(l[i]){l[n]=true}l[s]=f.result;l[o]=true;a.setValue("");r.refresh()};f.readAsDataURL(d)}},_listFilter:function(e,t,i){var n=this.getView().byId(e);var s=new l(t,sap.ui.model.FilterOperator.EQ,i);var o=n.getBinding("items");o.filter([s])}})});