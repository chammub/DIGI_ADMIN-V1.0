sap.ui.define(["sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,i,o,r){"use strict";return e.extend("com.digiArtitus.controller.Billing",{constructor:function(e){this._oInstance=e;this._oView=e.getView();this.oViewModel=this._oView.getModel("oViewModel")},loadBillingModel:function(){this._oInstance.billingUnsubscribe=com.digiArtitus.FirestoreInstance().collection("DATABASE").doc(com.digiArtitus.companyCode).collection("COLLECTION").onSnapshot(function(e){var t=[];e.forEach(function(e){t.push({NAME:e.data().NAME})});for(var i=0,o=t.length;i<o;i++){com.digiArtitus.FirestoreInstance().collection("DATABASE").doc(com.digiArtitus.companyCode).collection("ITEMS").where("COLLECTION","==",t[i].NAME).get().then(function(e){var t=[];e.forEach(function(e){if(e.data().ACTIVE){t.push({COLLECTION:e.data().COLLECTION,MENU:e.data().MENU,IMAGE_NAME:e.data().IMAGE_NAME,IMAGE_URL:e.data().IMAGE_URL,USER_COMPANY_CODE:e.data().USER_COMPANY_CODE,ITEM_CODE:e.data().ITEM_CODE,NAME:e.data().NAME,DESCRIPTION:e.data().DESCRIPTION,NET_PRICE:e.data().NET_PRICE,SALE_PRICE:e.data().SALE_PRICE,RANGE_OF_PRODUCTS:e.data().RANGE_OF_PRODUCTS,RANGE_OF_PRODUCTS_ITEMS:e.data().RANGE_OF_PRODUCTS_ITEMS})}});var i=0;var o=t.length;var r=[];if(o!==0){for(i=0;i<o;i++){if(t[i].RANGE_OF_PRODUCTS){for(var I=0,s=t[i].RANGE_OF_PRODUCTS_ITEMS.length;I<s;I++){r.push({COLLECTION:t[i].COLLECTION,MENU:t[i].MENU,IMAGE_NAME:t[i].IMAGE_NAME,IMAGE_URL:t[i].IMAGE_URL,USER_COMPANY_CODE:t[i].USER_COMPANY_CODE,ITEM_CODE:t[i].ITEM_CODE,NAME:t[i].NAME,DESCRIPTION:t[i].RANGE_OF_PRODUCTS_ITEMS[I].DESCRIPTION,NET_PRICE:parseFloat(t[i].RANGE_OF_PRODUCTS_ITEMS[I].NET_PRICE),SALE_PRICE:parseFloat(t[i].RANGE_OF_PRODUCTS_ITEMS[I].SALE_PRICE),DISCOUNT:this._fnDiscountPercentage(t[i].RANGE_OF_PRODUCTS_ITEMS[I].NET_PRICE,t[i].RANGE_OF_PRODUCTS_ITEMS[I].SALE_PRICE)})}}else{r.push({COLLECTION:t[i].COLLECTION,MENU:t[i].MENU,IMAGE_NAME:t[i].IMAGE_NAME,IMAGE_URL:t[i].IMAGE_URL,USER_COMPANY_CODE:t[i].USER_COMPANY_CODE,ITEM_CODE:t[i].ITEM_CODE,NAME:t[i].NAME,DESCRIPTION:t[i].DESCRIPTION,NET_PRICE:parseFloat(t[i].NET_PRICE),SALE_PRICE:parseFloat(t[i].SALE_PRICE),DISCOUNT:this._fnDiscountPercentage(t[i].NET_PRICE,t[i].SALE_PRICE)})}}}if(r.length===0){return}var l=r[0].COLLECTION+"_BILLING";var E=new sap.m.Button({icon:"sap-icon://add",type:sap.m.ButtonType.Ghost,text:r[0].COLLECTION,press:this.onBillingItemsAddPress.bind(this)}).addStyleClass("sapUiTinyMarginBegin");E.data("BINDING_ENTITY",l);var a=this._oView.byId("billing-dynamic-btn");a.addItem(E);this.oViewModel.setProperty("/"+l,r)}.bind(this))}}.bind(this))},_fnDiscountPercentage:function(e,t){var i=0;var o=0;var r=0;var I=0;o=parseFloat(e);i=parseFloat(t);r=o-i;I=r/o*100;I=Math.round(I)<=0?0:Math.round(I);return I},_billingPageDefaults:function(){this.oViewModel.setProperty("/BILLING_NAME","");this.oViewModel.setProperty("/BILLING_STREET_NO",com.digiArtitus.billingStreetNo);this.oViewModel.setProperty("/BILLING_STREET",com.digiArtitus.billingStreet);this.oViewModel.setProperty("/BILLING_CITY",com.digiArtitus.billingCity);this.oViewModel.setProperty("/BILLING_ZIPCODE",com.digiArtitus.billingZipcode);this.oViewModel.setProperty("/BILLING_COUNTRY",com.digiArtitus.billingCountry);this.oViewModel.setProperty("/BILLING_PHONE_NO","");this.oViewModel.setProperty("/BILLING_EMAIL","");this.oViewModel.setProperty("/BILLING_ITEMS",[])},_validateInput:function(e){var t=e.getBinding("value");var i="None";var o=false;try{t.getType().validateValue(e.getValue())}catch(t){i="Error";o=true;e.focus()}e.setValueState(i);return o},onBillingItemsAddPress:function(e){if(!this._oBillingDialog){this._oBillingDialog=sap.ui.xmlfragment(this._oView.getId(),"com.digiArtitus.fragment.billing-items",this)}var i="/"+e.getSource().data("BINDING_ENTITY");var o=this._oView.getModel("oBillingModel");if(o){o.destroy()}this._oBillingDialog.setModel(new t(this.oViewModel.getProperty(i)),"oBillingModel");var r=true;this._oBillingDialog.setMultiSelect(r);var I=false;this._oBillingDialog.setRememberSelections(I);this._oView.addDependent(this._oBillingDialog);jQuery.sap.syncStyleClass("sapUiSizeCompact",this._oView,this._oBillingDialog);this._oBillingDialog.open()},onBillingItemsDialogSearch:function(e){var t=e.getParameter("value");var o=new i("NAME",sap.ui.model.FilterOperator.Contains,t);var r=e.getSource().getBinding("items");r.filter([o])},onBillingItemsDialogClose:function(e){var t=e.getParameter("selectedContexts");if(t&&t.length){var i=[];t.map(function(e){i.push({IMAGE_URL:e.getObject().IMAGE_URL,COLLECTION:e.getObject().COLLECTION,MENU:e.getObject().MENU,ITEM_CODE:e.getObject().ITEM_CODE,NAME:e.getObject().NAME,DESCRIPTION:e.getObject().DESCRIPTION,NET_PRICE:e.getObject().NET_PRICE,SALE_PRICE:e.getObject().SALE_PRICE,DISCOUNT:e.getObject().DISCOUNT,QUANTITY:1,TOTAL_PRICE:e.getObject().SALE_PRICE})});this.oViewModel.setProperty("/BILLING_ITEMS",i);this._updateBillTotal()}else{r.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onBillingItemDelete:function(e){var t=e.getParameter("listItem").getBindingContext("oViewModel");var i=t.getPath();var o=i.substr(i.lastIndexOf("/")+1);var r=this.oViewModel.getProperty("/BILLING_ITEMS");r.splice(o,1);this.oViewModel.setProperty("/BILLING_ITEMS",r);this._updateBillTotal()},onBillingQuantityLiveChange:function(e){var t=e.getSource().getBindingContext("oViewModel");var i=t.getObject();var o=t.getPath();var r=e.getParameter("value");var I=parseFloat(i.SALE_PRICE*r);this.oViewModel.setProperty(o+"/TOTAL_PRICE",I);this._updateBillTotal()},_updateBillTotal:function(){var e=0;var t=this.oViewModel.getProperty("/BILLING_ITEMS");var i=this.oViewModel.getProperty("/BILLING_DELIVERY_CHARGE_CHECK");var o=this.oViewModel.getProperty("/BILLING_DELIVERY_CHARGE");for(var r=0,I=t.length;r<I;r++){e+=parseFloat(t[r].TOTAL_PRICE)}this.oViewModel.setProperty("/BILLING_TOTAL_PRICE",e);if(e<=i){e+=o}this.oViewModel.setProperty("/BILLING_TOTAL_PAYABLE",e)},onBillingCreateOrder:function(){var e=this._oInstance;var t=this._oView;var i=[t.byId("BillingName"),t.byId("BillingStreetNumber"),t.byId("BillingStreet"),t.byId("BillingCity"),t.byId("BillingZipCode")];var I=false;jQuery.each(i,function(t,i){I=e._validateInput(i)||I});var s=this.oViewModel.getProperty("/BILLING_ITEMS");if(s.length===0){r.show("Minimum one item is required to create order!");return}if(I){o.error("A validation error has occurred. Complete your input first");return}this.oViewModel.setProperty("/BILLING_NAME",t.byId("BillingName").getValue());this.oViewModel.setProperty("/BILLING_STREET_NO",t.byId("BillingStreetNumber").getValue());this.oViewModel.setProperty("/BILLING_CITY",t.byId("BillingCity").getValue());this.oViewModel.setProperty("/BILLING_ZIPCODE",t.byId("BillingZipCode").getValue());this.oViewModel.setProperty("/BILLING_PHONE_NO",t.byId("BillingPhoneNo").getValue());this.oViewModel.setProperty("/BILLING_EMAIL",t.byId("BillingEmail").getValue());var l=function(){var e=$.Deferred();var t=!!this._oView.$().closest(".sapUiSizeCompact").length;o.warning("Confirm to place order",{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],styleClass:t?"sapUiSizeCompact":"",onClose:function(t){if(t==="OK"){e.resolve("create")}}});return e.promise()}.bind(this);$.when(l()).done(function(e){com.digiArtitus.StartGlobalBusyIndicator();var t=this.oViewModel.getProperty("/BILLING_ITEMS");for(var i=0,o=t.length;i<o;i++){t[i].NET_PRICE=parseFloat(t[i].NET_PRICE).toFixed(2);t[i].SALE_PRICE=parseFloat(t[i].SALE_PRICE).toFixed(2);t[i].TOTAL_PRICE=parseFloat(t[i].TOTAL_PRICE).toFixed(2)}var r={USER_ID:com.digiArtitus.userId,USER_COMPANY_CODE:com.digiArtitus.companyCode,TIME_STAMP:firebase.firestore.Timestamp.fromDate(new Date),ORDER_ID:"ORD"+(new Date).getTime(),ORDER_TYPE:"POS",ORDER_STATUS:"RECEIVED",TOTAL_PRICE:parseFloat(this.oViewModel.getProperty("/BILLING_TOTAL_PRICE")).toFixed(2),TOTAL_PAYABLE:parseFloat(this.oViewModel.getProperty("/BILLING_TOTAL_PAYABLE")),DELIVERY_CHARGE:this.oViewModel.getProperty("/BILLING_TOTAL_PRICE")<=this.oViewModel.getProperty("/BILLING_DELIVERY_CHARGE_CHECK")?parseFloat(this.oViewModel.getProperty("/BILLING_DELIVERY_CHARGE")).toFixed(2):"0.00",ITEMS:t,CUSTOMER:{NAME:this.oViewModel.getProperty("/BILLING_NAME"),ADDRESS:this.oViewModel.getProperty("/BILLING_STREET_NO")+", "+this.oViewModel.getProperty("/BILLING_STREET"),CITY:this.oViewModel.getProperty("/BILLING_CITY"),STATE:this.oViewModel.getProperty("/BILLING_ZIPCODE"),COUNTRY:this.oViewModel.getProperty("/BILLING_COUNTRY"),PHONE_NO:this.oViewModel.getProperty("/BILLING_PHONE_NO"),EMAIL_ID:this.oViewModel.getProperty("/BILLING_EMAIL")}};com.digiArtitus.FirestoreInstance().collection("DATABASE").doc(com.digiArtitus.companyCode).collection("ORDERS").add(r).then(function(){this._oInstance._setSelectedNavBar("Dashboard");this.oViewModel.setProperty("/BILLING_TOTAL_PAYABLE",0);this.oViewModel.setProperty("/BILLING_TOTAL_PRICE",0);this.oViewModel.setProperty("/BILLING_ITEMS",[]);this.oViewModel.setProperty("/BILLING_NAME","");this.oViewModel.setProperty("/BILLING_STREET_NO",com.digiArtitus.billingStreetNo);this.oViewModel.setProperty("/BILLING_STREET",com.digiArtitus.billingStreet);this.oViewModel.setProperty("/BILLING_CITY",com.digiArtitus.billingCity);this.oViewModel.setProperty("/BILLING_ZIPCODE",com.digiArtitus.billingZipcode);this.oViewModel.setProperty("/BILLING_PHONE_NO","");this.oViewModel.setProperty("/BILLING_EMAIL","");com.digiArtitus.EndGlobalBusyIndicator()}.bind(this))}.bind(this))}})});